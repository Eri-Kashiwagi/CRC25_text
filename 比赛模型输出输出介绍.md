## 1. 输入数据：GeoDataFrame `df`

* 每行代表一条边，包含核心字段：
  | 字段名                          | 类型 / 单位       | 说明                        |
| --------------------------------- | ------------------- | ----------------------------- |
| `geometry`                  | `LINESTRING`  | 边的几何形状                |
| `path_type`                 | `str`         | 通行模式（"walk" / "bike"） |
| `curb_height_max`           | `float`（米） | 路缘最大高度                |
| `obstacle_free_width_float` | `float`（米） | 可通行宽度                  |
| `crossing`                  | `bool`        | 是否为路口                  |
| `length`                    | `float`（米） | 边长                        |
  
  
* 通过 `handle_weight(df, user_model, map)` 处理后，新增两列：
  1. `include`：是否参与最短路计算（0/1）
     * 规则：
       * 若 `curb_height_max > max_curb_height` 或
         `obstacle_free_width_float < min_sidewalk_width`
         → `include = 0`
       * 否则 → `include = 1`
  2. `my_weight`：综合权重，用于 Dijkstra
     my\_weight = length
     × (crossing ? crossing\_weight\_factor : 1)
     × (path\_type == walk\_bike\_preference
     ? walk\_bike\_preference\_weight\_factor : 1)

---

## 2. 用户模型 `user_model`

* `max_curb_height`：最大可接受路缘高度（米）
* `min_sidewalk_width`：最小人行道宽度（米）
* `walk_bike_preference`：出行方式（"walk" 或 "bike"）
* `attrs_variable_names`：用于相似度计算的属性名列表
* `crossing_weight_factor`：路口权重因子
* `walk_bike_preference_weight_factor`：偏好权重因子
* `route_error_threshold`：路径误差终止阈值

---

## 3. 地图参数 `map`

* `CRS` / `CRS_map`：坐标参考系
* `area_choice`：区域选择模式
* `my_areas`：自定义关注区域列表

---

## 4. 构建图 `G`

1. 从 `df[df.include == 1]` 中提取可行边
2. 用 `networkx.MultiDiGraph` 构建有向多重图，节点和边属性保持：
   * `geometry`、`path_type`、`curb_height_max`、`obstacle_free_width_float`
   * `include = 1`
   * `my_weight`

---

## 5. Foil 路径：GeoDataFrame `df_foil_path`

* 与 `df` 格式一致
* 只包含比赛提供的“目标路线”边，用于后续对比

---

## 6. 扰动策略（Perturbation）

* 可调整的属性
  * `curb_height_max`：在给定范围内增减
  * `obstacle_free_width_float`：在给定范围内增减
  * `path_type`：切换 "walk" / "bike"
* 影响
  * 调整后可能改变该边的 `include`
  * 或者改变其 `my_weight`

---

## 7. 最短路查询与相似度计算

1. 最短路查询
   fact\_path = nx.shortest\_path(G, source, target, weight="my\_weight")
   df\_fact\_path = df.loc[fact\_path]  
2. 相似度（Similarity）
   * 设
     * P\_f：fact 路径上的所有边
     * P\_o：foil 路径上的所有边
     * ℓ(e)：边 e 的长度
   * 公共长度：
     L\_cap = ∑\_{e ∈ P\_f ∩ P\_o} ℓ(e)
   * 各自总长：
     L\_f = ∑​*{e ∈ P\_f} ℓ(e),   L\_o = ∑*​{e ∈ P\_o} ℓ(e)
   * 相似度：
     sim = 2·L\_cap / (L\_f + L\_o)
     route\_error = 1 – sim
3. 终止条件
   route\_error < route\_error\_threshold
4. 目标：在满足终止条件的前提下，使 扰动次数 最少

---

## 8. 最终输出

* `fact_path`：最终生成的路径（边列表）
* `df`：扰动后完整的 GeoDataFrame


